name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        type: choice
        options: [preview, production]
        default: preview
        required: true
      pr_number:
        description: "PR number (preview only, for fork PRs after code review)"
        type: string
        required: false
      commit_sha:
        description: "Exact commit SHA you reviewed"
        type: string
        required: false

permissions:
  contents: read
  packages: write
  pull-requests: write
  deployments: write
  actions: read

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  PULUMI_ORG: davidbyoung
  PULUMI_PROJECT: aphiria-com-infrastructure
  # Pulumi operation timeouts (seconds)
  PULUMI_PREVIEW_TIMEOUT: 300 # 5min - Fast feedback for preview
  PULUMI_DEPLOY_TIMEOUT: 420 # 7min - Standard deployment
  PULUMI_BASE_DEPLOY_TIMEOUT: 1200 # 20min - Base infrastructure with cluster provisioning

jobs:
  determine-mode:
    name: Determine Build Mode
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      mode: ${{ steps.detect.outputs.mode }}
      pr-number: ${{ steps.detect.outputs.pr-number }}
      commit-sha: ${{ steps.detect.outputs.commit-sha }}
      is-safe: ${{ steps.detect.outputs.is-safe }}

    steps:
      - name: Detect build mode and extract metadata
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            let mode, prNumber, commitSha, isSafe;

            if (context.eventName === 'workflow_run') {
              // Triggered by CI workflow completion
              const workflowRun = context.payload.workflow_run;

              // üîí SECURITY: Check if this is from a fork
              const isFromFork = workflowRun.head_repository.full_name !== context.payload.repository.full_name;

              if (isFromFork) {
                core.warning(`üö´ Skipping build - workflow triggered from fork: ${workflowRun.head_repository.full_name}`);
                core.warning(`   Fork PRs require manual workflow_dispatch after code review`);
                isSafe = 'false';
                core.setOutput('mode', '');
                core.setOutput('pr-number', '');
                core.setOutput('commit-sha', '');
                core.setOutput('is-safe', 'false');
                return;
              }

              commitSha = workflowRun.head_sha;

              if (workflowRun.event === 'pull_request') {
                // Preview mode: CI completed on PR from internal branch
                mode = 'preview';

                // Get PR number from the workflow run
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: `${context.repo.owner}:${workflowRun.head_branch}`
                });

                if (prs.length === 0) {
                  core.setFailed('Could not find PR for this workflow run');
                  return;
                }

                prNumber = prs[0].number;
                isSafe = 'true';

                core.info(`üìã CI passed on internal PR - Preview mode`);
                core.info(`   PR: #${prNumber}`);
                core.info(`   Commit: ${commitSha}`);
              } else if (workflowRun.event === 'push' && workflowRun.head_branch === 'master') {
                // Production mode: CI completed on master push
                mode = 'production';
                prNumber = '';
                isSafe = 'true';

                core.info(`üöÄ CI passed on master - Production mode`);
                core.info(`   Commit: ${commitSha}`);
              } else {
                core.info(`‚ÑπÔ∏è  CI completed on branch ${workflowRun.head_branch} - Skipping build`);
                isSafe = 'false';
                core.setOutput('mode', '');
                core.setOutput('pr-number', '');
                core.setOutput('commit-sha', '');
                core.setOutput('is-safe', 'false');
                return;
              }
            } else if (context.eventName === 'workflow_dispatch') {
              // Manual trigger (for fork PRs after code review)
              mode = context.payload.inputs.environment;

              if (mode === 'preview') {
                if (!context.payload.inputs.pr_number || !context.payload.inputs.commit_sha) {
                  core.setFailed('‚ùå Preview mode requires pr_number and commit_sha inputs');
                  return;
                }

                prNumber = context.payload.inputs.pr_number;
                commitSha = context.payload.inputs.commit_sha;

                // üîí SECURITY: Validate commit belongs to PR (prevents deploying arbitrary code)
                const { data: commits } = await github.rest.pulls.listCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: parseInt(prNumber),
                  per_page: 100
                });

                const commitExists = commits.some(c => c.sha === commitSha);
                if (!commitExists) {
                  core.setFailed(`‚ùå Commit ${commitSha} does not belong to PR #${prNumber}`);
                  return;
                }

                isSafe = 'true';
                core.info(`‚úÖ Manual trigger (fork PR after review) - Preview mode`);
                core.info(`   PR: #${prNumber}`);
                core.info(`   Commit: ${commitSha}`);
              } else {
                // Production manual trigger
                prNumber = '';
                commitSha = context.sha;
                isSafe = 'true';

                core.info(`‚úÖ Manual trigger - Production mode`);
                core.info(`   Commit: ${commitSha}`);
              }
            } else {
              core.setFailed(`‚ùå Unsupported event: ${context.eventName}`);
              return;
            }

            core.setOutput('mode', mode);
            core.setOutput('pr-number', String(prNumber));
            core.setOutput('commit-sha', commitSha);
            core.setOutput('is-safe', String(isSafe));

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: determine-mode
    if: needs.determine-mode.outputs.is-safe == 'true'

    outputs:
      web-digest: ${{ steps.web-image.outputs.digest }}
      api-digest: ${{ steps.api-image.outputs.digest }}

    steps:
      - name: Check out exact commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.determine-mode.outputs.commit-sha }}

      - name: Verify correct commit
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          EXPECTED_SHA="${{ needs.determine-mode.outputs.commit-sha }}"

          if [ "$CURRENT_SHA" != "$EXPECTED_SHA" ]; then
            echo "‚ùå ERROR: Checked out wrong commit!"
            echo "   Expected: $EXPECTED_SHA"
            echo "   Got:      $CURRENT_SHA"
            exit 1
          fi

          echo "‚úÖ Verified - building commit: $CURRENT_SHA"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image tags
        id: meta
        run: |
          MODE="${{ needs.determine-mode.outputs.mode }}"
          COMMIT_SHA="${{ needs.determine-mode.outputs.commit-sha }}"
          COMMIT_SHA_SHORT="${COMMIT_SHA:0:7}"

          if [ "$MODE" == "preview" ]; then
            PR_NUMBER="${{ needs.determine-mode.outputs.pr-number }}"
            BUILD_TAGS="${REGISTRY}/${IMAGE_PREFIX}-build:pr-${PR_NUMBER},${REGISTRY}/${IMAGE_PREFIX}-build:pr-${PR_NUMBER}-${COMMIT_SHA_SHORT}"
            WEB_TAGS="${REGISTRY}/${IMAGE_PREFIX}-web:pr-${PR_NUMBER},${REGISTRY}/${IMAGE_PREFIX}-web:pr-${PR_NUMBER}-${COMMIT_SHA_SHORT}"
            API_TAGS="${REGISTRY}/${IMAGE_PREFIX}-api:pr-${PR_NUMBER},${REGISTRY}/${IMAGE_PREFIX}-api:pr-${PR_NUMBER}-${COMMIT_SHA_SHORT}"
            CACHE_SCOPE_SUFFIX="pr-${PR_NUMBER}"
          else
            BUILD_TAGS="${REGISTRY}/${IMAGE_PREFIX}-build:latest,${REGISTRY}/${IMAGE_PREFIX}-build:sha-${COMMIT_SHA_SHORT}"
            WEB_TAGS="${REGISTRY}/${IMAGE_PREFIX}-web:latest,${REGISTRY}/${IMAGE_PREFIX}-web:sha-${COMMIT_SHA_SHORT}"
            API_TAGS="${REGISTRY}/${IMAGE_PREFIX}-api:latest,${REGISTRY}/${IMAGE_PREFIX}-api:sha-${COMMIT_SHA_SHORT}"
            CACHE_SCOPE_SUFFIX="master"
          fi

          echo "BUILD_TAGS=${BUILD_TAGS}" >> $GITHUB_OUTPUT
          echo "WEB_TAGS=${WEB_TAGS}" >> $GITHUB_OUTPUT
          echo "API_TAGS=${API_TAGS}" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA_SHORT=${COMMIT_SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "CACHE_SCOPE_SUFFIX=${CACHE_SCOPE_SUFFIX}" >> $GITHUB_OUTPUT
          echo "BUILD_IMAGE_REF=${REGISTRY}/${IMAGE_PREFIX}-build:$([ "$MODE" == "preview" ] && echo "pr-${PR_NUMBER}-${COMMIT_SHA_SHORT}" || echo "sha-${COMMIT_SHA_SHORT}")" >> $GITHUB_OUTPUT

      - name: Build documentation image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infrastructure/docker/build/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.BUILD_TAGS }}
          cache-from: |
            type=gha,scope=build-${{ steps.meta.outputs.CACHE_SCOPE_SUFFIX }}
            type=gha,scope=build
            type=gha,scope=build-master
          cache-to: |
            type=gha,mode=max,scope=build-${{ steps.meta.outputs.CACHE_SCOPE_SUFFIX }}
            type=gha,mode=max,scope=build
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ needs.determine-mode.outputs.commit-sha }}

      - name: Build web image
        id: web-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infrastructure/docker/runtime/web/Dockerfile
          build-args: |
            BUILD_IMAGE=${{ steps.meta.outputs.BUILD_IMAGE_REF }}
          push: true
          tags: ${{ steps.meta.outputs.WEB_TAGS }}
          cache-from: |
            type=gha,scope=web-${{ steps.meta.outputs.CACHE_SCOPE_SUFFIX }}
            type=gha,scope=web
            type=gha,scope=web-master
          cache-to: |
            type=gha,mode=max,scope=web-${{ steps.meta.outputs.CACHE_SCOPE_SUFFIX }}
            type=gha,mode=max,scope=web
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ needs.determine-mode.outputs.commit-sha }}

      - name: Build API image
        id: api-image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infrastructure/docker/runtime/api/Dockerfile
          build-args: |
            BUILD_IMAGE=${{ steps.meta.outputs.BUILD_IMAGE_REF }}
          push: true
          tags: ${{ steps.meta.outputs.API_TAGS }}
          cache-from: |
            type=gha,scope=api-${{ steps.meta.outputs.CACHE_SCOPE_SUFFIX }}
            type=gha,scope=api
            type=gha,scope=api-master
          cache-to: |
            type=gha,mode=max,scope=api-${{ steps.meta.outputs.CACHE_SCOPE_SUFFIX }}
            type=gha,mode=max,scope=api
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ needs.determine-mode.outputs.commit-sha }}

      - name: Output image digests
        run: |
          MODE="${{ needs.determine-mode.outputs.mode }}"

          echo "### üì¶ Image Digests ($MODE)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Web Image**: \`${{ steps.web-image.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**API Image**: \`${{ steps.api-image.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Image**: \`${{ steps.build-image.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These digests will be used for $MODE environment deployment." >> $GITHUB_STEP_SUMMARY

      - name: Add comment to PR with image digests
        if: needs.determine-mode.outputs.mode == 'preview'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.determine-mode.outputs.pr-number }};
            const webDigest = '${{ steps.web-image.outputs.digest }}';
            const apiDigest = '${{ steps.api-image.outputs.digest }}';
            const commitSha = '${{ steps.meta.outputs.COMMIT_SHA_SHORT }}';
            const fullSha = '${{ needs.determine-mode.outputs.commit-sha }}';

            const body = `### üì¶ Preview Images Built

            **Commit**: \`${commitSha}\` (\`${fullSha}\`)

            **Image Digests**:
            - **Web**: \`${webDigest}\`
            - **API**: \`${apiDigest}\`

            These images are ready for preview environment deployment.
            Approve the preview deployment to create an ephemeral environment.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body,
            });

  ensure-base-stack:
    name: Ensure Preview Base Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [determine-mode, build]
    if: |
      always() &&
      needs.build.result == 'success' &&
      needs.determine-mode.outputs.mode == 'preview'

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: infrastructure/pulumi/package-lock.json

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install Pulumi dependencies and build
        run: |
          cd infrastructure/pulumi
          npm ci
          npm run build

      - name: Ensure preview-base stack exists and is deployed
        uses: actions/github-script@v7
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        with:
          script: |
            async function checkStackExists(stackName) {
              try {
                await exec.exec('pulumi', ['stack', 'select', stackName], {
                  silent: true,
                  cwd: 'infrastructure/pulumi'
                });
                return true;
              } catch {
                return false;
              }
            }

            async function checkClusterDeployed(stackName) {
              let output = '';
              try {
                await exec.exec('pulumi', ['stack', 'output', 'clusterId', '--stack', stackName], {
                  silent: true,
                  cwd: 'infrastructure/pulumi',
                  listeners: {
                    stdout: (data) => { output += data.toString(); }
                  }
                });
                return output.trim() !== '';
              } catch {
                return false;
              }
            }

            async function pulumiRefresh(stackName) {
              await exec.exec('pulumi', ['refresh', '--stack', stackName, '--yes'], {
                cwd: 'infrastructure/pulumi',
                timeout: process.env.PULUMI_DEPLOY_TIMEOUT * 1000,
              });
            }

            async function deployWithRetry(stackName) {
              const maxRetries = 3;
              const baseDelay = 60000;

              for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                  await exec.exec('pulumi', ['up', '--stack', stackName, '--yes'], {
                    cwd: 'infrastructure/pulumi',
                    timeout: process.env.PULUMI_BASE_DEPLOY_TIMEOUT * 1000,
                  });

                  core.info(`‚úÖ ${stackName} deployed successfully`);
                  return;
                } catch (error) {
                  if (attempt < maxRetries - 1) {
                    const delay = baseDelay * (attempt + 1);
                    core.warning(`‚ö†Ô∏è  Deployment failed (attempt ${attempt + 1}/${maxRetries}). Retrying in ${delay}ms...`);
                    core.info('   (Kubernetes API may still be initializing - this is normal on first deployment)');
                    await new Promise(r => setTimeout(r, delay));
                  } else {
                    throw error;
                  }
                }
              }
            }

            core.info('Checking if preview-base stack exists...');
            const stackExists = await checkStackExists('preview-base');

            if (stackExists) {
              core.info('‚úÖ Base stack "preview-base" exists');
              const clusterDeployed = await checkClusterDeployed('preview-base');

              if (clusterDeployed) {
                core.info('‚úÖ Base infrastructure exists - deploying latest changes');
                await deployWithRetry('preview-base');
              } else {
                core.warning('‚ö†Ô∏è  Base stack exists but cluster not deployed - deploying now...');
                core.info('   This likely means a previous deployment failed partway through.');
                core.info('üîÑ Refreshing Pulumi state to match actual infrastructure...');
                await pulumiRefresh('preview-base');
                await deployWithRetry('preview-base');
              }
            } else {
              core.info('üì¶ Creating and deploying base stack "preview-base"...');
              await exec.exec('pulumi', ['stack', 'init', 'preview-base'], { cwd: 'infrastructure/pulumi' });
              await exec.exec('pulumi', ['config', 'env', 'add', 'aphiria.com/Preview', '--stack', 'preview-base', '--yes'], { cwd: 'infrastructure/pulumi' });
              core.info('üöÄ Deploying preview base infrastructure (this will take 5-10 minutes)...');
              await deployWithRetry('preview-base');
            }

  preview-infra:
    name: Preview Infrastructure Changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [determine-mode, build, ensure-base-stack]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.ensure-base-stack.result == 'success' || needs.ensure-base-stack.result == 'skipped')

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: infrastructure/pulumi/package-lock.json

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install dependencies and build
        run: |
          cd infrastructure/pulumi
          npm ci
          npm run build

      - name: Run Pulumi preview
        id: preview
        working-directory: infrastructure/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          set -e

          MODE="${{ needs.determine-mode.outputs.mode }}"

          if [ "$MODE" == "preview" ]; then
            PR_NUMBER=${{ needs.determine-mode.outputs.pr-number }}
            STACK_NAME="preview-pr-${PR_NUMBER}"
            PULUMI_ENV="aphiria.com/Preview"
            BASE_STACK_REF="${PULUMI_ORG}/${PULUMI_PROJECT}/preview-base"
          else
            STACK_NAME="production"
            PULUMI_ENV="aphiria.com/Production"
          fi

          if ! pulumi stack select "${STACK_NAME}" 2>/dev/null; then
            pulumi stack init "${STACK_NAME}"
          fi

          pulumi config env add "${PULUMI_ENV}" --stack "${STACK_NAME}" --yes

          if [ "$MODE" == "preview" ]; then
            # Set PR-specific configuration values
            pulumi config set prNumber "${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set baseStackReference "${BASE_STACK_REF}" --stack "${STACK_NAME}"
            pulumi config set --path 'namespace.name' "preview-pr-${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set --path 'postgresql.databaseName' "aphiria_pr_${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set --path 'app.web.url' "https://${PR_NUMBER}.pr.aphiria.com" --stack "${STACK_NAME}"
            pulumi config set --path 'app.web.image' "${{ needs.build.outputs.web-digest }}" --stack "${STACK_NAME}"
            pulumi config set --path 'app.api.url' "https://${PR_NUMBER}.pr-api.aphiria.com" --stack "${STACK_NAME}"
            pulumi config set --path 'app.api.image' "${{ needs.build.outputs.api-digest }}" --stack "${STACK_NAME}"
          else
            # Production uses image config paths
            pulumi config set --path 'app.web.image' "${{ needs.build.outputs.web-digest }}" --stack "${STACK_NAME}"
            pulumi config set --path 'app.api.image' "${{ needs.build.outputs.api-digest }}" --stack "${STACK_NAME}"
          fi

          set +e
          if [ "$MODE" == "preview" ]; then
            # Use --config-file to merge with template for preview
            timeout ${{ env.PULUMI_PREVIEW_TIMEOUT }} pulumi preview --stack "${STACK_NAME}" --config-file Pulumi.preview-pr.yaml --non-interactive 2>&1 | tee preview.txt
          else
            # Production doesn't need config-file
            timeout ${{ env.PULUMI_PREVIEW_TIMEOUT }} pulumi preview --stack "${STACK_NAME}" --non-interactive 2>&1 | tee preview.txt
          fi
          PREVIEW_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          exit $PREVIEW_EXIT_CODE

      - name: Post preview comment on PR
        if: always() && steps.preview.outcome != 'skipped' && needs.determine-mode.outputs.mode == 'preview'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ needs.determine-mode.outputs.pr-number }};

            let preview = '';
            try {
              preview = fs.readFileSync('infrastructure/pulumi/preview.txt', 'utf8');
            } catch (error) {
              preview = 'Preview output not available';
            }

            const maxLength = 60000;
            if (preview.length > maxLength) {
              preview = preview.substring(0, maxLength) + '\n\n... (truncated)';
            }

            const status = '${{ steps.preview.outcome }}' === 'success' ? '‚úÖ Preview Succeeded' : '‚ùå Preview Failed';

            const body = `## üîç Infrastructure Preview - ${status}

            <details>
            <summary>Click to expand Pulumi preview output</summary>

            \`\`\`
            ${preview}
            \`\`\`

            </details>

            ---
            **Next Step**: Review the preview above. If it looks good, approve the deployment in the GitHub Actions UI.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [determine-mode, build, preview-infra]
    if: |
      always() &&
      needs.build.result == 'success' &&
      needs.preview-infra.result == 'success'

    environment:
      name: ${{ needs.determine-mode.outputs.mode == 'preview' && format('preview-pr-{0}', needs.determine-mode.outputs.pr-number) || 'production' }}
      url: ${{ needs.determine-mode.outputs.mode == 'preview' && format('https://{0}.pr.aphiria.com', needs.determine-mode.outputs.pr-number) || 'https://www.aphiria.com' }}

    concurrency:
      group: ${{ needs.determine-mode.outputs.mode == 'preview' && format('preview-{0}', needs.determine-mode.outputs.pr-number) || 'production' }}
      cancel-in-progress: false

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: infrastructure/pulumi/package-lock.json

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install dependencies and build
        run: |
          cd infrastructure/pulumi
          npm ci
          npm run build

      - name: Deploy infrastructure
        working-directory: infrastructure/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          MODE="${{ needs.determine-mode.outputs.mode }}"

          if [ "$MODE" == "preview" ]; then
            PR_NUMBER=${{ needs.determine-mode.outputs.pr-number }}
            STACK_NAME="preview-pr-${PR_NUMBER}"
            PULUMI_ENV="aphiria.com/Preview"
            BASE_STACK_REF="${PULUMI_ORG}/${PULUMI_PROJECT}/preview-base"
          else
            STACK_NAME="production"
            PULUMI_ENV="aphiria.com/Production"
          fi

          pulumi stack select "${STACK_NAME}"
          pulumi config env add "${PULUMI_ENV}" --stack "${STACK_NAME}" --yes

          if [ "$MODE" == "preview" ]; then
            # Set PR-specific configuration values
            pulumi config set prNumber "${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set baseStackReference "${BASE_STACK_REF}" --stack "${STACK_NAME}"
            pulumi config set --path 'namespace.name' "preview-pr-${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set --path 'postgresql.databaseName' "aphiria_pr_${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set --path 'app.web.url' "https://${PR_NUMBER}.pr.aphiria.com" --stack "${STACK_NAME}"
            pulumi config set --path 'app.web.image' "${{ needs.build.outputs.web-digest }}" --stack "${STACK_NAME}"
            pulumi config set --path 'app.api.url' "https://${PR_NUMBER}.pr-api.aphiria.com" --stack "${STACK_NAME}"
            pulumi config set --path 'app.api.image' "${{ needs.build.outputs.api-digest }}" --stack "${STACK_NAME}"
          else
            # Production uses image config paths
            pulumi config set --path 'app.web.image' "${{ needs.build.outputs.web-digest }}" --stack "${STACK_NAME}"
            pulumi config set --path 'app.api.image' "${{ needs.build.outputs.api-digest }}" --stack "${STACK_NAME}"
          fi

          # Retry deployment with refresh on failure to handle orphaned resources
          if [ "$MODE" == "preview" ]; then
            if ! timeout ${{ env.PULUMI_DEPLOY_TIMEOUT }} pulumi up --stack "${STACK_NAME}" --config-file Pulumi.preview-pr.yaml --yes; then
              echo "Deployment failed, refreshing state and retrying once..."
              pulumi refresh --stack "${STACK_NAME}" --yes
              timeout ${{ env.PULUMI_DEPLOY_TIMEOUT }} pulumi up --stack "${STACK_NAME}" --config-file Pulumi.preview-pr.yaml --yes
            fi
          else
            if ! timeout ${{ env.PULUMI_DEPLOY_TIMEOUT }} pulumi up --stack "${STACK_NAME}" --yes; then
              echo "Deployment failed, refreshing state and retrying once..."
              pulumi refresh --stack "${STACK_NAME}" --yes
              timeout ${{ env.PULUMI_DEPLOY_TIMEOUT }} pulumi up --stack "${STACK_NAME}" --yes
            fi
          fi

      - name: Post deployment success comment (preview)
        if: success() && needs.determine-mode.outputs.mode == 'preview'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.determine-mode.outputs.pr-number }};
            const previewUrl = `https://${prNumber}.pr.aphiria.com`;
            const grafanaUrl = `https://pr-grafana.aphiria.com`;

            const body = `## ‚úÖ Preview Environment Deployed

            üåê **Preview URL**: ${previewUrl}
            üìä **Grafana Dashboard**: ${grafanaUrl}

            The preview environment has been successfully deployed and is ready for testing.

            **Environment Details:**
            - PR: #${prNumber}
            - Web Image: \`${{ needs.build.outputs.web-digest }}\`
            - API Image: \`${{ needs.build.outputs.api-digest }}\`
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Post deployment success summary (production)
        if: success() && needs.determine-mode.outputs.mode == 'production'
        run: |
          echo "### ‚úÖ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üåê **Production URL**: https://www.aphiria.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- Web: \`${{ needs.build.outputs.web-digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- API: \`${{ needs.build.outputs.api-digest }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Post deployment failure comment (preview)
        if: failure() && needs.determine-mode.outputs.mode == 'preview'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.determine-mode.outputs.pr-number }};

            const body = `## ‚ùå Preview Environment Deployment Failed

            The deployment encountered an error. Please check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Post deployment failure summary (production)
        if: failure() && needs.determine-mode.outputs.mode == 'production'
        run: |
          echo "### ‚ùå Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [determine-mode, deploy]
    if: |
      always() &&
      needs.deploy.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install root TypeScript dependencies
        run: npm ci

      - name: Install e2e dependencies
        working-directory: tests/e2e
        run: npm ci

      - name: Install Playwright browsers
        working-directory: tests/e2e
        run: npx playwright install --with-deps chromium webkit

      - name: Construct URLs
        run: |
          MODE="${{ needs.determine-mode.outputs.mode }}"
          PR="${{ needs.determine-mode.outputs.pr-number }}"

          if [ "$MODE" = "preview" ]; then
            echo "APP_ENV=preview" >> $GITHUB_ENV
            echo "SITE_BASE_URL=https://${PR}.pr.aphiria.com" >> $GITHUB_ENV
            echo "GRAFANA_BASE_URL=https://pr-grafana.aphiria.com" >> $GITHUB_ENV
            echo "COOKIE_DOMAIN=.pr.aphiria.com" >> $GITHUB_ENV
          else
            echo "APP_ENV=production" >> $GITHUB_ENV
            echo "SITE_BASE_URL=https://www.aphiria.com" >> $GITHUB_ENV
            echo "GRAFANA_BASE_URL=https://grafana.aphiria.com" >> $GITHUB_ENV
            echo "COOKIE_DOMAIN=.aphiria.com" >> $GITHUB_ENV
          fi

      - name: Validate required environment variables
        run: |
          required_vars=("SITE_BASE_URL" "GRAFANA_BASE_URL" "COOKIE_DOMAIN" "APP_ENV")

          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "::error::Required environment variable $var is not set"
              exit 1
            fi
            echo "‚úÖ $var=${!var}"
          done

          echo "‚úÖ All required environment variables validated"

      - name: Run smoke tests
        working-directory: tests/e2e
        run: npm run test:e2e

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-artifacts-${{ needs.determine-mode.outputs.mode }}
          path: |
            tests/e2e/playwright-report/
            tests/e2e/test-results/
          retention-days: 7
