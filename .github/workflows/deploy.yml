name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        options: [preview, production]
        required: true
      pr_number:
        description: 'PR number (preview only)'
        type: number
        required: false
      web_digest:
        description: 'Full SHA256 digest for web image'
        required: true
        type: string
      api_digest:
        description: 'Full SHA256 digest for API image'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  ensure-base-stack:
    name: Ensure Base Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: inputs.environment == 'preview'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install Pulumi dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Ensure preview-base stack exists and is deployed
        uses: actions/github-script@v7
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        with:
          script: |
            async function checkStackExists(stackName) {
              try {
                await exec.exec('pulumi', ['stack', 'select', stackName], {
                  silent: true,
                  cwd: 'infrastructure/pulumi'
                });
                return true;
              } catch {
                return false;
              }
            }

            async function checkClusterDeployed(stackName) {
              let output = '';
              try {
                await exec.exec('pulumi', ['stack', 'output', 'clusterId', '--stack', stackName], {
                  silent: true,
                  cwd: 'infrastructure/pulumi',
                  listeners: {
                    stdout: (data) => { output += data.toString(); }
                  }
                });
                return output.trim() !== '';
              } catch {
                return false;
              }
            }

            async function pulumiRefresh(stackName) {
              await exec.exec('pulumi', ['refresh', '--stack', stackName, '--yes'], {
                cwd: 'infrastructure/pulumi'
              });
            }

            async function deployWithRetry(stackName) {
              const maxRetries = 3;
              const baseDelay = 60000;

              for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                  await exec.exec('pulumi', ['up', '--stack', stackName, '--yes'], {
                    cwd: 'infrastructure/pulumi'
                  });
                  core.info(`‚úÖ ${stackName} deployed successfully`);
                  return;
                } catch (error) {
                  if (attempt < maxRetries - 1) {
                    const delay = baseDelay * (attempt + 1);
                    core.warning(`‚ö†Ô∏è  Deployment failed (attempt ${attempt + 1}/${maxRetries}). Retrying in ${delay}ms...`);
                    core.info('   (Kubernetes API may still be initializing - this is normal on first deployment)');
                    await new Promise(r => setTimeout(r, delay));
                  } else {
                    throw error;
                  }
                }
              }
            }

            core.info('Checking if preview-base stack exists...');
            const stackExists = await checkStackExists('preview-base');

            if (stackExists) {
              core.info('‚úÖ Base stack "preview-base" exists');
              const clusterDeployed = await checkClusterDeployed('preview-base');

              if (clusterDeployed) {
                core.info('‚úÖ Base infrastructure already deployed');
                await pulumiRefresh('preview-base');
              } else {
                core.warning('‚ö†Ô∏è  Base stack exists but cluster not deployed - deploying now...');
                core.info('   This likely means a previous deployment failed partway through.');
                core.info('üîÑ Refreshing Pulumi state to match actual infrastructure...');
                await pulumiRefresh('preview-base');
                await deployWithRetry('preview-base');
              }
            } else {
              core.info('üì¶ Creating and deploying base stack "preview-base"...');
              await exec.exec('pulumi', ['stack', 'init', 'preview-base'], { cwd: 'infrastructure/pulumi' });
              await exec.exec('pulumi', ['config', 'env', 'add', 'aphiria.com/Preview', '--stack', 'preview-base', '--yes'], { cwd: 'infrastructure/pulumi' });
              core.info('üöÄ Deploying preview base infrastructure (this will take 5-10 minutes)...');
              await deployWithRetry('preview-base');
            }

  preview-infra:
    name: Preview Infrastructure Changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: ensure-base-stack
    # If the previous job was skipped, we still need to run this (likewise if it was successful)
    if: ${{ always() && (needs.ensure-base-stack.result == 'success' || needs.ensure-base-stack.result == 'skipped') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Run Pulumi preview
        id: preview
        working-directory: infrastructure/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          set -e

          ENV="${{ inputs.environment }}"

          if [ "$ENV" == "preview" ]; then
            PR_NUMBER=${{ inputs.pr_number }}
            STACK_NAME="preview-pr-${PR_NUMBER}"
            PULUMI_ENV="aphiria.com/Preview"
            BASE_STACK_REF="davidbyoung/aphiria-com-infrastructure/preview-base"
          else
            STACK_NAME="production"
            PULUMI_ENV="aphiria.com/Production"
          fi

          if ! pulumi stack select "${STACK_NAME}" 2>/dev/null; then
            pulumi stack init "${STACK_NAME}"
          fi

          pulumi config env add "${PULUMI_ENV}" --stack "${STACK_NAME}" --yes

          if [ "$ENV" == "preview" ]; then
            pulumi config set prNumber "${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set baseStackReference "${BASE_STACK_REF}" --stack "${STACK_NAME}"
            # Use placeholder digests for preview (actual digests set in deploy job)
            pulumi config set webImageDigest "sha256:preview" --stack "${STACK_NAME}"
            pulumi config set apiImageDigest "sha256:preview" --stack "${STACK_NAME}"
          else
            # Use actual digests for production preview
            pulumi config set webImageDigest "${{ inputs.web_digest }}" --stack "${STACK_NAME}"
            pulumi config set apiImageDigest "${{ inputs.api_digest }}" --stack "${STACK_NAME}"
          fi

          set +e
          pulumi preview --stack "${STACK_NAME}" --non-interactive 2>&1 | tee preview.txt
          PREVIEW_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          exit $PREVIEW_EXIT_CODE

      - name: Post preview comment on PR
        if: always() && steps.preview.outcome != 'skipped' && inputs.environment == 'preview'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ inputs.pr_number }};

            let preview = '';
            try {
              preview = fs.readFileSync('infrastructure/pulumi/preview.txt', 'utf8');
            } catch (error) {
              preview = 'Preview output not available';
            }

            const maxLength = 60000;
            if (preview.length > maxLength) {
              preview = preview.substring(0, maxLength) + '\n\n... (truncated)';
            }

            const status = '${{ steps.preview.outcome }}' === 'success' ? '‚úÖ Preview Succeeded' : '‚ùå Preview Failed';

            const body = `## üîç Infrastructure Preview - ${status}

            <details>
            <summary>Click to expand Pulumi preview output</summary>

            \`\`\`
            ${preview}
            \`\`\`

            </details>

            ---
            **Next Step**: Review the preview above. If it looks good, approve the deployment in the GitHub Actions UI.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: preview-infra
    # If the previous job was successful, run this job (the skipped first job causes issues with using success())
    if: ${{ always() && needs.preview-infra.result == 'success' }}

    environment:
      name: ${{ inputs.environment == 'preview' && format('preview-pr-{0}', inputs.pr_number) || 'production' }}
      url: ${{ inputs.environment == 'preview' && format('https://{0}.pr.aphiria.com', inputs.pr_number) || 'https://www.aphiria.com' }}

    concurrency:
      group: ${{ inputs.environment == 'preview' && format('preview-{0}', inputs.pr_number) || 'production' }}
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Deploy infrastructure
        working-directory: infrastructure/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          ENV="${{ inputs.environment }}"

          if [ "$ENV" == "preview" ]; then
            PR_NUMBER=${{ inputs.pr_number }}
            STACK_NAME="preview-pr-${PR_NUMBER}"
            PULUMI_ENV="aphiria.com/Preview"
            BASE_STACK_REF="davidbyoung/aphiria-com-infrastructure/preview-base"
          else
            STACK_NAME="production"
            PULUMI_ENV="aphiria.com/Production"
          fi

          pulumi stack select "${STACK_NAME}"

          pulumi config env add "${PULUMI_ENV}" --stack "${STACK_NAME}" --yes

          if [ "$ENV" == "preview" ]; then
            pulumi config set prNumber "${PR_NUMBER}" --stack "${STACK_NAME}"
            pulumi config set baseStackReference "${BASE_STACK_REF}" --stack "${STACK_NAME}"
          fi

          pulumi config set webImageDigest "${{ inputs.web_digest }}" --stack "${STACK_NAME}"
          pulumi config set apiImageDigest "${{ inputs.api_digest }}" --stack "${STACK_NAME}"

          pulumi up --stack "${STACK_NAME}" --yes

      - name: Post deployment success comment (preview)
        if: success() && inputs.environment == 'preview'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const previewUrl = `https://${prNumber}.pr.aphiria.com`;

            const body = `## ‚úÖ Preview Environment Deployed

            üåê **Preview URL**: ${previewUrl}

            The preview environment has been successfully deployed and is ready for testing.

            **Environment Details:**
            - PR: #${prNumber}
            - Web Image: \`${{ inputs.web_digest }}\`
            - API Image: \`${{ inputs.api_digest }}\`
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Post deployment success summary (production)
        if: success() && inputs.environment == 'production'
        run: |
          echo "### ‚úÖ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üåê **Production URL**: https://www.aphiria.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- Web: \`${{ inputs.web_digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- API: \`${{ inputs.api_digest }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Post deployment failure comment (preview)
        if: failure() && inputs.environment == 'preview'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};

            const body = `## ‚ùå Preview Environment Deployment Failed

            The deployment encountered an error. Please check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Post deployment failure summary (production)
        if: failure() && inputs.environment == 'production'
        run: |
          echo "### ‚ùå Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
