name: build-deploy
on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 */6 * * *' # Deploy the website every 6 hours
jobs:
  build-base-image:
    name: Build Base Image
    uses: ./.github/workflows/build-docker-image.yml
    with:
      dockerfile: ./infrastructure/docker/build/Dockerfile
      image: davidbyoung/aphiria.com-build
      image-sha-artifact-name: build-image-sha
    secrets:
      DOCKER_ACCESS_TOKEN: ${{ secrets.DOCKER_ACCESS_TOKEN }}
  build-runtime-images:
    name: Build Runtime Images
    needs: build-base-image
    strategy:
      fail-fast: true
      matrix:
        include:
          - dockerfile: ./infrastructure/docker/runtime/api/Dockerfile
            image: davidbyoung/aphiria.com-api
            image-sha-artifact-name: api-image-sha
          - dockerfile: ./infrastructure/docker/runtime/web/Dockerfile
            image: davidbyoung/aphiria.com-web
            image-sha-artifact-name: web-image-sha
    uses: ./.github/workflows/build-docker-image.yml
    with:
      dockerfile: ${{ matrix.dockerfile }}
      image: ${{ matrix.image }}
      image-sha-artifact-name: ${{ matrix.image-sha-artifact-name }}
    secrets:
      DOCKER_ACCESS_TOKEN: ${{ secrets.DOCKER_ACCESS_TOKEN }}
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: build-runtime-images
    environment: production
    steps:
      - name: Check Out Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download SHA Artifact
        uses: actions/download-artifact@v4
        with:
          # Technically, an artifact for each image will be uploaded.  We just choose one here, but all should have the same content.
          name: api-image-sha
      - name: Install Dependencies
        run: |
          chmod +x ./install.sh
          ./install.sh --install-pulumi --install-helm --install-helmfile --install-doctl
      - name: Pulumi Infrastructure
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DIGITALOCEAN_SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DIGITALOCEAN_SPACES_SECRET_KEY }}
          AWS_REGION: us-east-1
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          DIGITALOCEAN_SPACES_ACCESS_KEY: ${{ secrets.DIGITALOCEAN_SPACES_ACCESS_KEY }}
          DIGITALOCEAN_SPACES_SECRET_KEY: ${{ secrets.DIGITALOCEAN_SPACES_SECRET_KEY }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
        run: |
          # Install dependencies and login to Pulumi backend
          cd ./infrastructure/pulumi
          npm install
          pulumi login s3://aphiria-com-infrastructure?endpoint=nyc3.digitaloceanspaces.com&region=us-east-1&s3ForcePathStyle=true

          # Try to select prod stack, create if it doesn't exist
          pulumi stack select prod 2>/dev/null || pulumi stack init prod

          # Check if stack has any resources (migration check)
          resource_count=$(pulumi stack --show-urns 2>/dev/null | grep -c "urn:pulumi:" || echo "0")

          if [ "$resource_count" -eq "0" ]; then
            echo "⚠️  WARNING: Pulumi stack is empty. Resources need to be imported first!"
            echo "Please run ./infrastructure/pulumi/import-resources.sh locally before deploying."
            echo "Skipping Pulumi deployment to prevent resource duplication."
            exit 0
          fi

          # Preview and apply changes
          pulumi preview --non-interactive --stack prod
          pulumi up --non-interactive --stack prod --yes --skip-preview
      - name: Configure Kubernetes Cluster
        run: |
          # Save the kubeconfig so that kubectl commands apply to the DigitalOcean cluster
          doctl auth init --access-token ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          cd ./infrastructure/pulumi
          cluster_id=$(pulumi stack output clusterId --stack prod)
          cd ../..
          doctl kubernetes cluster kubeconfig save $cluster_id

          # Install Helmfiles
          helmfile -f ./infrastructure/kubernetes/base/helmfile.yml repos
          helmfile -f ./infrastructure/kubernetes/base/helmfile.yml sync

          # Write secrets to files so we can apply them
          echo "${{ secrets.KUBERNETES_SECRETS }}" > ./infrastructure/kubernetes/environments/prod/core/secrets.yml
          echo "${{ secrets.DIGITALOCEAN_SECRETS }}" > ./infrastructure/kubernetes/environments/prod/gateway-api/secrets.yml

          # Update the DB migration job to use the latest Docker image
          image_sha=$(cat image_sha.txt)
          echo "Image SHA: $image_sha"
          sed -i "s|davidbyoung/aphiria.com-api:latest|davidbyoung/aphiria.com-api:${image_sha}|g" ./infrastructure/kubernetes/base/database/jobs.yml
          kubectl delete job db-migration --ignore-not-found

          # Apply prod kustomization
          kubectl apply -k ./infrastructure/kubernetes/environments/prod

          # Use the latest Docker images in our pods
          kubectl set image deployment/api php=davidbyoung/aphiria.com-api:${image_sha}
          kubectl set image deployment/api copy-api-code=davidbyoung/aphiria.com-api:${image_sha}
          kubectl set image deployment/web web=davidbyoung/aphiria.com-web:${image_sha}
