name: build-deploy
on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 */6 * * *' # Deploy the website every 6 hours
jobs:
  build-base-image:
    name: Build Base Image
    uses: ./.github/workflows/build-docker-image.yml
    with:
      dockerfile: ./infrastructure/docker/build/Dockerfile
      image: davidbyoung/aphiria.com-build
      image-sha-artifact-name: build-image-sha
    secrets:
      DOCKER_ACCESS_TOKEN: ${{ secrets.DOCKER_ACCESS_TOKEN }}
  build-runtime-images:
    name: Build Runtime Images
    needs: build-base-image
    strategy:
      fail-fast: true
      matrix:
        include:
          - dockerfile: ./infrastructure/docker/runtime/api/Dockerfile
            image: davidbyoung/aphiria.com-api
            image-sha-artifact-name: api-image-sha
          - dockerfile: ./infrastructure/docker/runtime/web/Dockerfile
            image: davidbyoung/aphiria.com-web
            image-sha-artifact-name: web-image-sha
    uses: ./.github/workflows/build-docker-image.yml
    with:
      dockerfile: ${{ matrix.dockerfile }}
      image: ${{ matrix.image }}
      image-sha-artifact-name: ${{ matrix.image-sha-artifact-name }}
    secrets:
      DOCKER_ACCESS_TOKEN: ${{ secrets.DOCKER_ACCESS_TOKEN }}
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: build-runtime-images
    environment: production
    steps:
      - name: Check Out Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download SHA Artifact
        uses: actions/download-artifact@v4
        with:
          # Technically, an artifact for each image will be uploaded.  We just choose one here, but all should have the same content.
          name: api-image-sha
      - name: Set Up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: Terraform Kubernetes
        run: |
          terraform -chdir=./infrastructure/terraform init -backend-config="access_key=${{ secrets.DIGITALOCEAN_SPACES_ACCESS_KEY }}" -backend-config="secret_key=${{ secrets.DIGITALOCEAN_SPACES_SECRET_KEY }}"
          terraform -chdir=./infrastructure/terraform validate
          terraform -chdir=./infrastructure/terraform plan -target="module.kubernetes" -var="do_access_token=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" -var="do_spaces_access_key=${{ secrets.DIGITALOCEAN_SPACES_ACCESS_KEY }}" -var="do_spaces_secret_key=${{ secrets.DIGITALOCEAN_SPACES_SECRET_KEY }}" -no-color -input=false
          terraform -chdir=./infrastructure/terraform apply -target="module.kubernetes" -var="do_access_token=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" -var="do_spaces_access_key=${{ secrets.DIGITALOCEAN_SPACES_ACCESS_KEY }}" -var="do_spaces_secret_key=${{ secrets.DIGITALOCEAN_SPACES_SECRET_KEY }}" -no-color -input=false -auto-approve
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save $(terraform-bin -chdir=./infrastructure/terraform output -raw cluster_id)
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Helmfile
        run: |
          curl -L https://github.com/helmfile/helmfile/releases/download/v1.0.0-rc.7/helmfile_1.0.0-rc.7_linux_amd64.tar.gz -o helmfile.tar.gz
          tar -xzf helmfile.tar.gz
          sudo mv helmfile /usr/local/bin/helmfile
          helmfile --version
      - name: Install Helm Charts
        run: |
          helmfile -f ./infrastructure/kubernetes/base/helmfile.yml repos
          helmfile -f ./infrastructure/kubernetes/base/helmfile.yml sync
      - name: Configure Kubernetes Cluster
        run: |
          # Write secrets to files so we can apply them
          echo "${{ secrets.KUBERNETES_SECRETS }}" > ./infrastructure/kubernetes/environments/prod/core/secrets.yml
          echo "${{ secrets.DIGITALOCEAN_SECRETS }}" > ./infrastructure/kubernetes/environments/prod/gateway-api/secrets.yml

          # Apply configs
          kubectl apply -k ./infrastructure/kubernetes/environments/prod

          # Use the latest Docker images
          image_sha=$(cat image_sha.txt)
          echo "Image SHA: $image_sha"
          kubectl set image deployment/api php=davidbyoung/aphiria.com-api:${image_sha}
          kubectl set image deployment/api copy-api-code=davidbyoung/aphiria.com-api:${image_sha}
          kubectl set image deployment/web web=davidbyoung/aphiria.com-web:${image_sha}
      - name: Terraform DigitalOcean Networking and Monitoring
        run: |
          terraform -chdir=./infrastructure/terraform plan -target="module.networking" -target="module.monitoring" -var="do_access_token=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" -var="do_spaces_access_key=${{ secrets.DIGITALOCEAN_SPACES_ACCESS_KEY }}" -var="do_spaces_secret_key=${{ secrets.DIGITALOCEAN_SPACES_SECRET_KEY }}"  -no-color -input=false
          terraform -chdir=./infrastructure/terraform apply -target="module.networking" -target="module.monitoring" -var="do_access_token=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" -var="do_spaces_access_key=${{ secrets.DIGITALOCEAN_SPACES_ACCESS_KEY }}" -var="do_spaces_secret_key=${{ secrets.DIGITALOCEAN_SPACES_SECRET_KEY }}"  -no-color -input=false -auto-approve
