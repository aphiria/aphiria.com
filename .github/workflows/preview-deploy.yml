name: Preview Environment Deploy

on:
  workflow_run:
    workflows: ["Build Preview Images"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  ensure-base-stack:
    name: Ensure Base Stack Exists
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install Pulumi dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Ensure base stack exists
        working-directory: infrastructure/pulumi/ephemeral
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          # Check if ephemeral-base stack exists
          if pulumi stack select ephemeral-base 2>/dev/null; then
            echo "‚úÖ Base stack 'ephemeral-base' exists"
            pulumi refresh --stack ephemeral-base --yes
          else
            echo "üì¶ Creating base stack 'ephemeral-base'..."
            pulumi stack init ephemeral-base

            # Set base stack configuration
            pulumi config set --secret postgresql:adminPassword "${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}"
            if [ -n "${{ secrets.POSTGRESQL_ADMIN_USER }}" ]; then
              pulumi config set postgresql:adminUser "${{ secrets.POSTGRESQL_ADMIN_USER }}"
            fi

            # Deploy base infrastructure
            pulumi up --stack ephemeral-base --yes
          fi

  preview-infra:
    name: Preview Infrastructure Changes
    runs-on: ubuntu-latest
    needs: ensure-base-stack
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;

            if (context.eventName === 'workflow_dispatch') {
              prNumber = ${{ inputs.pr_number || 0 }};
            } else {
              // Get PR number from workflow_run event
              const pullRequests = context.payload.workflow_run.pull_requests;
              if (pullRequests && pullRequests.length > 0) {
                prNumber = pullRequests[0].number;
              } else {
                // Fallback: get PR from head branch
                const branchName = context.payload.workflow_run.head_branch;
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${context.repo.owner}:${branchName}`,
                  state: 'open'
                });

                if (prs.length === 0) {
                  core.setFailed(`No open PR found for branch ${branchName}`);
                  return;
                }

                prNumber = prs[0].number;
              }
            }

            console.log(`PR Number: ${prNumber}`);
            core.setOutput('number', prNumber);

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

      - name: Run Pulumi preview
        id: preview
        working-directory: infrastructure/pulumi/ephemeral
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          STACK_NAME="ephemeral-pr-${PR_NUMBER}"

          # Select or create stack
          pulumi stack select "${STACK_NAME}" 2>/dev/null || pulumi stack init "${STACK_NAME}"

          # Set minimal config required for preview (full config set in deploy job)
          pulumi config set prNumber "${PR_NUMBER}"
          pulumi config set baseStackReference "davidbyoung/ephemeral-environments/ephemeral-base"
          pulumi config set --secret postgresql:adminPassword "preview-only"
          pulumi config set webImageDigest "sha256:preview"
          pulumi config set apiImageDigest "sha256:preview"

          # Run preview
          pulumi preview --stack "${STACK_NAME}" --non-interactive 2>&1 | tee preview.txt

      - name: Add preview comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ steps.pr.outputs.number }};
            const preview = fs.readFileSync('infrastructure/pulumi/ephemeral/preview.txt', 'utf8');

            const body = `## üîç Infrastructure Preview

            \`\`\`
            ${preview}
            \`\`\`

            Review changes above, then approve deployment in Actions tab.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Infrastructure Preview'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const body = `## ‚ùå Preview Environment Failed

            The preview environment deployment failed during infrastructure validation.

            **Error**: Check the [workflow logs](${runUrl}) for details.

            Common issues:
            - TypeScript compilation errors
            - Missing secrets or configuration
            - Pulumi stack errors

            Please fix the errors and push again to retry (may require fixing it, merging this pull request, then opening a new one).`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });

  check-author:
    name: Check PR Author
    runs-on: ubuntu-latest
    needs: preview-infra
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      is-maintainer: ${{ steps.check.outputs.is-maintainer }}
      pr-number: ${{ steps.pr.outputs.number }}

    steps:
      - name: Extract PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;

            if (context.eventName === 'workflow_dispatch') {
              prNumber = ${{ inputs.pr_number || 0 }};
            } else {
              // Get PR number from workflow_run event
              const pullRequests = context.payload.workflow_run.pull_requests;
              if (pullRequests && pullRequests.length > 0) {
                prNumber = pullRequests[0].number;
              } else {
                // Fallback: get PR from head branch
                const branchName = context.payload.workflow_run.head_branch;
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${context.repo.owner}:${branchName}`,
                  state: 'open'
                });

                if (prs.length === 0) {
                  core.setFailed(`No open PR found for branch ${branchName}`);
                  return;
                }

                prNumber = prs[0].number;
              }
            }

            console.log(`PR Number: ${prNumber}`);
            core.setOutput('number', prNumber);

      - name: Check if PR author is maintainer
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const prAuthor = pr.user.login;
            console.log(`PR Author: ${prAuthor}`);

            // Check if PR author has admin permissions on the repository
            let isMaintainer = false;
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: prAuthor,
              });

              console.log(`PR Author permission level: ${permission.permission}`);

              // Auto-approve for admin or maintain permission
              isMaintainer = permission.permission === 'admin' || permission.permission === 'maintain';
            } catch (error) {
              console.log(`Could not fetch permission level: ${error.message}`);
              isMaintainer = false;
            }

            core.setOutput('is-maintainer', isMaintainer);

            if (isMaintainer) {
              console.log('‚úÖ PR author has admin/maintain permissions - auto-approving deployment');
            } else {
              console.log('‚è≥ PR author does not have admin/maintain permissions - manual approval required');
            }

  deploy:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    needs: check-author
    if: ${{ needs.check-author.outputs.is-maintainer == 'true' }}

    concurrency:
      group: preview-${{ needs.check-author.outputs.pr-number }}
      cancel-in-progress: false

    steps:
      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}" ]; then
            MISSING_SECRETS+=("POSTGRESQL_ADMIN_PASSWORD")
          fi

          if [ -z "${{ secrets.PULUMI_ACCESS_TOKEN }}" ]; then
            MISSING_SECRETS+=("PULUMI_ACCESS_TOKEN")
          fi

          if [ -z "${{ secrets.KUBECONFIG }}" ]; then
            MISSING_SECRETS+=("KUBECONFIG")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "::error::Missing required secrets: ${MISSING_SECRETS[*]}"
            echo ""
            echo "Please add the following secrets to your repository:"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo ""
            for secret in "${MISSING_SECRETS[@]}"; do
              case "$secret" in
                POSTGRESQL_ADMIN_PASSWORD)
                  echo "  ‚Ä¢ POSTGRESQL_ADMIN_PASSWORD: PostgreSQL admin password"
                  echo "    Retrieve from production: kubectl get secret env-var-secrets -o jsonpath='{.data.DB_PASSWORD}' | base64 -d"
                  echo "    Or generate new: openssl rand -base64 32"
                  ;;
                PULUMI_ACCESS_TOKEN)
                  echo "  ‚Ä¢ PULUMI_ACCESS_TOKEN: Pulumi Cloud access token"
                  echo "    Create at: https://app.pulumi.com/settings/tokens"
                  ;;
                KUBECONFIG)
                  echo "  ‚Ä¢ KUBECONFIG: Kubernetes cluster configuration (base64 encoded)"
                  echo "    Encode: cat ~/.kube/config | base64 -w 0"
                  ;;
              esac
              echo ""
            done
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set PR number
        id: pr
        run: |
          PR_NUMBER="${{ needs.check-author.outputs.pr-number }}"
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "Deploying preview for PR #${PR_NUMBER}"

      - name: Get image digests from PR labels
        id: images
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const webDigestLabel = pr.labels.find(l => l.name.startsWith('web-digest:'));
            const apiDigestLabel = pr.labels.find(l => l.name.startsWith('api-digest:'));

            if (!webDigestLabel || !apiDigestLabel) {
              core.setFailed('Image digest labels not found. Please rebuild preview images.');
              return;
            }

            const webDigest = 'sha256:' + webDigestLabel.name.replace('web-digest:', '');
            const apiDigest = 'sha256:' + apiDigestLabel.name.replace('api-digest:', '');

            core.setOutput('web-digest', webDigest);
            core.setOutput('api-digest', apiDigest);

            console.log(`Web digest: ${webDigest}`);
            console.log(`API digest: ${apiDigest}`);

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install Pulumi dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Configure Pulumi stack
        working-directory: infrastructure/pulumi/ephemeral
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          STACK_NAME="ephemeral-pr-${PR_NUMBER}"

          # Select or create stack
          pulumi stack select "${STACK_NAME}" || pulumi stack init "${STACK_NAME}"

          # Set stack configuration
          pulumi config set prNumber "${PR_NUMBER}"
          pulumi config set webImageDigest "${{ steps.images.outputs.web-digest }}"
          pulumi config set apiImageDigest "${{ steps.images.outputs.api-digest }}"
          pulumi config set baseStackReference "davidbyoung/ephemeral-environments/ephemeral-base"

          # Set PostgreSQL credentials (from secrets)
          pulumi config set --secret postgresql:adminPassword "${{ secrets.POSTGRESQL_ADMIN_PASSWORD }}"

          # Optional: Set custom DB user if different from 'postgres'
          if [ -n "${{ secrets.POSTGRESQL_ADMIN_USER }}" ]; then
            pulumi config set postgresql:adminUser "${{ secrets.POSTGRESQL_ADMIN_USER }}"
          fi

      - name: Deploy preview environment
        id: deploy
        working-directory: infrastructure/pulumi/ephemeral
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          STACK_NAME="ephemeral-pr-${PR_NUMBER}"

          # Deploy with timeout
          timeout 600 pulumi up --stack "${STACK_NAME}" --yes

          # Capture outputs
          WEB_URL=$(pulumi stack output webUrl --stack "${STACK_NAME}")
          API_URL=$(pulumi stack output apiUrl --stack "${STACK_NAME}")
          DB_NAME=$(pulumi stack output databaseName --stack "${STACK_NAME}")

          echo "web-url=${WEB_URL}" >> $GITHUB_OUTPUT
          echo "api-url=${API_URL}" >> $GITHUB_OUTPUT
          echo "db-name=${DB_NAME}" >> $GITHUB_OUTPUT
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Wait for pods to be ready
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          NAMESPACE="ephemeral-pr-${PR_NUMBER}"

          echo "Waiting for pods in namespace ${NAMESPACE}..."

          # Wait up to 5 minutes for all pods to be ready
          kubectl wait --for=condition=Ready pods --all \
            --namespace="${NAMESPACE}" \
            --timeout=300s || {
              echo "::warning::Some pods did not become ready within timeout"
              kubectl get pods -n "${NAMESPACE}"
            }

      - name: Verify deployment health
        id: health-check
        continue-on-error: true
        run: |
          WEB_URL="${{ steps.deploy.outputs.web-url }}"
          API_URL="${{ steps.deploy.outputs.api-url }}"

          # Wait a bit for routing to propagate
          sleep 10

          # Check web health
          WEB_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "${WEB_URL}" || echo "000")
          echo "web-status=${WEB_STATUS}" >> $GITHUB_OUTPUT

          # Check API health
          API_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "${API_URL}" || echo "000")
          echo "api-status=${API_STATUS}" >> $GITHUB_OUTPUT

          if [ "${WEB_STATUS}" -ge "200" ] && [ "${WEB_STATUS}" -lt "400" ]; then
            echo "‚úÖ Web health check passed (HTTP ${WEB_STATUS})"
          else
            echo "‚ö†Ô∏è  Web health check returned HTTP ${WEB_STATUS}"
          fi

          if [ "${API_STATUS}" -ge "200" ] && [ "${API_STATUS}" -lt "400" ]; then
            echo "‚úÖ API health check passed (HTTP ${API_STATUS})"
          else
            echo "‚ö†Ô∏è  API health check returned HTTP ${API_STATUS}"
          fi

      - name: Add comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const webUrl = '${{ steps.deploy.outputs.web-url }}';
            const apiUrl = '${{ steps.deploy.outputs.api-url }}';
            const dbName = '${{ steps.deploy.outputs.db-name }}';
            const webStatus = '${{ steps.health-check.outputs.web-status }}' || 'unknown';
            const apiStatus = '${{ steps.health-check.outputs.api-status }}' || 'unknown';
            const commitSha = context.sha.substring(0, 7);

            const healthIcon = (status) => {
              const code = parseInt(status);
              if (code >= 200 && code < 400) return '‚úÖ';
              if (code >= 400) return '‚ùå';
              return '‚è≥';
            };

            const body = `### üöÄ Preview Environment Deployed

            **PR**: #${prNumber}
            **Commit**: \`${commitSha}\`
            **Database**: \`${dbName}\`

            **Preview URLs**:
            - ${healthIcon(webStatus)} **Web**: ${webUrl}
            - ${healthIcon(apiStatus)} **API**: ${apiUrl}

            **Status**:
            - Web: HTTP ${webStatus}
            - API: HTTP ${apiStatus}

            ---
            *Preview environment will be automatically destroyed when this PR is closed or merged.*
            `;

            // Find existing deployment comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const deployComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Environment Deployed')
            );

            if (deployComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: deployComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }

  notify-manual-approval:
    name: Notify Manual Approval Required
    runs-on: ubuntu-latest
    needs: check-author
    if: ${{ needs.check-author.outputs.is-maintainer == 'false' }}

    steps:
      - name: Add comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-author.outputs.pr-number }};
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const body = `## ‚è≥ Manual Approval Required

            Preview environment deployment requires manual approval for non-maintainer contributions.

            A repository maintainer must approve the deployment in the [Actions tab](${runUrl}).

            **Note**: This is a security measure to prevent unauthorized resource usage.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
