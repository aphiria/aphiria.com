name: CI

on:
  push:
    branches:
      - master
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - php: "8.4"
          - php: "8.5"
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: public
          # This is a temporary database used just for CI
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
    # Need to make sure we're using the right environment variables when compiling the views
    env:
      APP_ENV: testing
      APP_WEB_URL: https://www.aphiria.com
      APP_API_URL: https://api.aphiria.com
      DB_HOST: localhost
      DB_PASSWORD: password
    name: Quality Gates (PHP ${{ matrix.php }})
    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: apcu, curl, dom, libxml, mbstring, pcntl, pgsql, xdebug, zip
          tools: composer:v2
          coverage: xdebug
          ini-values: apc.enable_cli=1

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Cache Composer packages
        uses: actions/cache@v5
        with:
          path: ~/.cache/composer
          key: composer-${{ runner.os }}-${{ hashFiles('apps/api/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Install dependencies
        run: |
          chmod +x ./install.sh
          make install INSTALL_ARGS="--install-pulumi"
          chmod -R 755 apps/api/tmp

      - name: Seed database
        run: make db-seed

      - name: Run quality gates
        if: matrix.php == '8.4'
        run: make quality-gates

      - name: Run PHP tests
        if: matrix.php != '8.4'
        run: make test-php

      - name: Upload PHP coverage
        if: matrix.php == '8.4'
        uses: codecov/codecov-action@v5
        with:
          files: ./apps/api/.coverage/clover.xml
          flags: api
          name: API
          slug: aphiria/aphiria.com
          token: ${{ secrets.CODECOV_TOKEN }}
          disable_search: true

      - name: Upload Web coverage
        if: matrix.php == '8.4'
        uses: codecov/codecov-action@v5
        with:
          files: ./apps/web/coverage/lcov.info
          flags: web
          name: Web
          slug: aphiria/aphiria.com
          token: ${{ secrets.CODECOV_TOKEN }}
          disable_search: true

      - name: Upload Pulumi coverage
        if: matrix.php == '8.4'
        uses: codecov/codecov-action@v5
        with:
          files: ./infrastructure/pulumi/coverage/lcov.info
          flags: pulumi
          name: Pulumi
          slug: aphiria/aphiria.com
          token: ${{ secrets.CODECOV_TOKEN }}
          disable_search: true

      - name: Upload Build Tools coverage
        if: matrix.php == '8.4'
        uses: codecov/codecov-action@v5
        with:
          files: ./tools/build-docs/coverage/lcov.info
          flags: tools
          name: Tools
          slug: aphiria/aphiria.com
          token: ${{ secrets.CODECOV_TOKEN }}
          disable_search: true
