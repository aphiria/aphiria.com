name: Preview Environment Deploy

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: number
      web_digest:
        description: 'Full SHA256 digest for web image'
        required: true
        type: string
      api_digest:
        description: 'Full SHA256 digest for API image'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  ensure-base-stack:
    name: Ensure Preview Base Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install Pulumi dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Ensure preview-base stack exists and is deployed
        uses: actions/github-script@v7
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        with:
          script: |
            const { exec } = require('@actions/exec');
            const core = require('@actions/core');

            async function checkStackExists(stackName) {
              try {
                await exec('pulumi', ['stack', 'select', stackName], {
                  silent: true,
                  cwd: 'infrastructure/pulumi'
                });
                return true;
              } catch {
                return false;
              }
            }

            async function checkClusterDeployed(stackName) {
              let output = '';
              try {
                await exec('pulumi', ['stack', 'output', 'clusterId', '--stack', stackName], {
                  silent: true,
                  cwd: 'infrastructure/pulumi',
                  listeners: {
                    stdout: (data) => { output += data.toString(); }
                  }
                });
                return output.trim() !== '';
              } catch {
                return false;
              }
            }

            async function pulumiRefresh(stackName) {
              await exec('pulumi', ['refresh', '--stack', stackName, '--yes'], {
                cwd: 'infrastructure/pulumi'
              });
            }

            async function deployWithRetry(stackName) {
              const maxRetries = 3;
              const baseDelay = 60000;

              for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                  await exec('pulumi', ['up', '--stack', stackName, '--yes'], {
                    cwd: 'infrastructure/pulumi'
                  });
                  core.info(`‚úÖ ${stackName} deployed successfully`);
                  return;
                } catch (error) {
                  if (attempt < maxRetries - 1) {
                    const delay = baseDelay * (attempt + 1);
                    core.warning(`‚ö†Ô∏è  Deployment failed (attempt ${attempt + 1}/${maxRetries}). Retrying in ${delay}ms...`);
                    core.info('   (Kubernetes API may still be initializing - this is normal on first deployment)');
                    await new Promise(r => setTimeout(r, delay));
                  } else {
                    throw error;
                  }
                }
              }
            }

            // Main logic
            core.info('Checking if preview-base stack exists...');
            const stackExists = await checkStackExists('preview-base');

            if (stackExists) {
              core.info('‚úÖ Base stack "preview-base" exists');
              const clusterDeployed = await checkClusterDeployed('preview-base');

              if (clusterDeployed) {
                core.info('‚úÖ Base infrastructure already deployed');
                await pulumiRefresh('preview-base');
              } else {
                core.warning('‚ö†Ô∏è  Base stack exists but cluster not deployed - deploying now...');
                core.info('   This likely means a previous deployment failed partway through.');
                core.info('üîÑ Refreshing Pulumi state to match actual infrastructure...');
                await pulumiRefresh('preview-base');
                await deployWithRetry('preview-base');
              }
            } else {
              core.info('üì¶ Creating and deploying base stack "preview-base"...');
              await exec('pulumi', ['stack', 'init', 'preview-base'], { cwd: 'infrastructure/pulumi' });
              await exec('pulumi', ['config', 'env', 'add', 'aphiria.com/Preview', '--stack', 'preview-base', '--yes'], { cwd: 'infrastructure/pulumi' });
              core.info('üöÄ Deploying preview base infrastructure (this will take 5-10 minutes)...');
              await deployWithRetry('preview-base');
            }

  preview-infra:
    name: Preview Infrastructure Changes
    runs-on: ubuntu-latest
    needs: ensure-base-stack

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Run Pulumi preview
        id: preview
        working-directory: infrastructure/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          set -e

          PR_NUMBER=${{ inputs.pr_number }}
          STACK_NAME="preview-pr-${PR_NUMBER}"

          if ! pulumi stack select "${STACK_NAME}" 2>/dev/null; then
            pulumi stack init "${STACK_NAME}"
            pulumi config env add aphiria.com/Preview --stack "${STACK_NAME}" --yes
          else
            if ! pulumi config env ls | grep -q "aphiria.com/Preview"; then
              pulumi config env add aphiria.com/Preview --stack "${STACK_NAME}" --yes
            fi
          fi

          pulumi config set prNumber "${PR_NUMBER}" --stack "${STACK_NAME}"
          pulumi config set baseStackReference "davidbyoung/aphiria-com-infrastructure/preview-base" --stack "${STACK_NAME}"
          pulumi config set webImageDigest "sha256:preview" --stack "${STACK_NAME}"
          pulumi config set apiImageDigest "sha256:preview" --stack "${STACK_NAME}"

          set +e
          pulumi preview --stack "${STACK_NAME}" --non-interactive 2>&1 | tee preview.txt
          PREVIEW_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          exit $PREVIEW_EXIT_CODE

      - name: Post preview comment on PR
        if: always() && steps.preview.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ inputs.pr_number }};

            let preview = '';
            try {
              preview = fs.readFileSync('infrastructure/pulumi/preview.txt', 'utf8');
            } catch (error) {
              preview = 'Preview output not available';
            }

            const maxLength = 60000;
            if (preview.length > maxLength) {
              preview = preview.substring(0, maxLength) + '\n\n... (truncated)';
            }

            const status = '${{ steps.preview.outcome }}' === 'success' ? '‚úÖ Preview Succeeded' : '‚ùå Preview Failed';

            const body = `## üîç Infrastructure Preview - ${status}

            <details>
            <summary>Click to expand Pulumi preview output</summary>

            \`\`\`
            ${preview}
            \`\`\`

            </details>

            ---
            **Next Step**: Review the preview above. If it looks good, approve the deployment in the GitHub Actions UI.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  deploy:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    needs: preview-infra

    environment:
      name: preview-pr-${{ inputs.pr_number }}
      url: https://${{ inputs.pr_number }}.pr.aphiria.com

    concurrency:
      group: preview-${{ inputs.pr_number }}
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install dependencies and build
        run: |
          cd infrastructure/pulumi
          npm install
          npm run build

      - name: Deploy preview environment
        working-directory: infrastructure/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          PR_NUMBER=${{ inputs.pr_number }}
          STACK_NAME="preview-pr-${PR_NUMBER}"

          pulumi stack select "${STACK_NAME}"

          pulumi config set prNumber "${PR_NUMBER}" --stack "${STACK_NAME}"
          pulumi config set baseStackReference "davidbyoung/aphiria-com-infrastructure/preview-base" --stack "${STACK_NAME}"
          pulumi config set webImageDigest "${{ inputs.web_digest }}" --stack "${STACK_NAME}"
          pulumi config set apiImageDigest "${{ inputs.api_digest }}" --stack "${STACK_NAME}"

          pulumi up --stack "${STACK_NAME}" --yes

      - name: Post deployment success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const previewUrl = `https://${prNumber}.pr.aphiria.com`;

            const body = `## ‚úÖ Preview Environment Deployed

            üåê **Preview URL**: ${previewUrl}

            The preview environment has been successfully deployed and is ready for testing.

            **Environment Details:**
            - PR: #${prNumber}
            - Web Image: \`${{ inputs.web_digest }}\`
            - API Image: \`${{ inputs.api_digest }}\`
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Post deployment failure comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};

            const body = `## ‚ùå Preview Environment Deployment Failed

            The deployment encountered an error. Please check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
